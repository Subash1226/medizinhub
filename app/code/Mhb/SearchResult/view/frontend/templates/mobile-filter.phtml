<!-- mobile-filter.phtml -->
<div class="cusrp-mobile-controls">
    <div class="cusrp-mobile-button-container">
        <div id="mobile-sort-button"  class="cusrp-mobile-sort cusrp-mobile-button">
            Sort&nbsp;
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="17" viewBox="0 0 16 17" fill="none">
                <path d="M4.79844 14.6091V6.60908M4.79844 14.6091L2.39844 12.2091M4.79844 14.6091L7.19844 12.2091M11.1984 1.80908V9.80908M11.1984 1.80908L13.5984 4.20908M11.1984 1.80908L8.79844 4.20908" stroke="#063851" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </div>
        <div id="mobile-filter-button" class="cusrp-mobile-filter cusrp-mobile-button">
            Filter&nbsp;
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="17" viewBox="0 0 16 17" fill="none">
                <path d="M12.4025 1.5424C12.5351 1.5424 12.6623 1.59508 12.756 1.68885C12.8498 1.78261 12.9025 1.90979 12.9025 2.0424L12.9025 5.4424C13.3177 5.55376 13.6846 5.79901 13.9463 6.14012C14.208 6.48123 14.3498 6.89914 14.3498 7.32907C14.3498 7.75899 14.208 8.1769 13.9463 8.51801C13.6846 8.85912 13.3177 9.10437 12.9025 9.21573L12.9025 14.3757C12.9025 14.5083 12.8498 14.6355 12.756 14.7293C12.6623 14.8231 12.5351 14.8757 12.4025 14.8757C12.2699 14.8757 12.1427 14.8231 12.0489 14.7293C11.9552 14.6355 11.9025 14.5083 11.9025 14.3757L11.9025 9.21573C11.4872 9.10437 11.1203 8.85912 10.8586 8.51801C10.5969 8.1769 10.4551 7.75899 10.4551 7.32907C10.4551 6.89914 10.5969 6.48123 10.8586 6.14012C11.1203 5.79901 11.4872 5.55376 11.9025 5.4424L11.9025 2.0424C11.9025 1.90979 11.9552 1.78261 12.0489 1.68885C12.1427 1.59508 12.2699 1.5424 12.4025 1.5424ZM3.59581 1.5424C3.72841 1.5424 3.85559 1.59508 3.94936 1.68885C4.04313 1.78261 4.09581 1.90979 4.09581 2.0424L4.09581 3.67573C4.51106 3.78709 4.87797 4.03234 5.13965 4.37345C5.40134 4.71456 5.54318 5.13248 5.54318 5.5624C5.54318 5.99232 5.40134 6.41024 5.13965 6.75135C4.87797 7.09246 4.51106 7.3377 4.09581 7.44907L4.09581 14.3757C4.09581 14.4414 4.08287 14.5064 4.05775 14.5671C4.03262 14.6277 3.99579 14.6829 3.94936 14.7293C3.90293 14.7757 3.84781 14.8125 3.78715 14.8377C3.72649 14.8628 3.66147 14.8757 3.59581 14.8757C3.53015 14.8757 3.46513 14.8628 3.40446 14.8377C3.3438 14.8125 3.28868 14.7757 3.24225 14.7293C3.19582 14.6829 3.15899 14.6277 3.13387 14.5671C3.10874 14.5064 3.09581 14.4414 3.09581 14.3757L3.09581 7.44907C2.68056 7.3377 2.31364 7.09246 2.05196 6.75135C1.79028 6.41024 1.64844 5.99232 1.64844 5.5624C1.64844 5.13248 1.79027 4.71456 2.05196 4.37345C2.31364 4.03234 2.68056 3.7871 3.09581 3.67573L3.09581 2.0424C3.09491 1.97649 3.10723 1.91107 3.13204 1.85C3.15685 1.78893 3.19365 1.73346 3.24025 1.68685C3.28686 1.64024 3.34234 1.60344 3.40341 1.57863C3.46448 1.55382 3.5299 1.5415 3.59581 1.5424ZM7.99581 1.5424C8.06172 1.5415 8.12714 1.55382 8.1882 1.57863C8.24927 1.60344 8.30475 1.64024 8.35136 1.68685C8.39797 1.73346 8.43476 1.78893 8.45957 1.85C8.48438 1.91107 8.4967 1.97649 8.49581 2.0424L8.49581 9.8424C8.91106 9.95376 9.27797 10.199 9.53965 10.5401C9.80134 10.8812 9.94318 11.2991 9.94318 11.7291C9.94318 12.159 9.80134 12.5769 9.53965 12.918C9.27797 13.2591 8.91106 13.5044 8.49581 13.6157L8.49581 14.3757C8.49581 14.5083 8.44313 14.6355 8.34936 14.7293C8.25559 14.8231 8.12841 14.8757 7.99581 14.8757C7.8632 14.8757 7.73602 14.8231 7.64225 14.7293C7.54849 14.6355 7.49581 14.5083 7.49581 14.3757L7.49581 13.6157C7.08056 13.5044 6.71364 13.2591 6.45196 12.918C6.19028 12.5769 6.04844 12.159 6.04844 11.7291C6.04844 11.2991 6.19028 10.8812 6.45196 10.5401C6.71364 10.199 7.08056 9.95376 7.49581 9.8424L7.49581 2.0424C7.49581 1.90979 7.54848 1.78261 7.64225 1.68885C7.73602 1.59508 7.8632 1.5424 7.99581 1.5424Z" fill="#063851"/>
            </svg>
        </div>
    </div>

    <!-- Mobile Sort Popup -->
    <div id="mobile-sort-popup" class="cusrp-mobile-popup">
        <div class="cusrp-mobile-popup-header">
            <div class="cusrp-mobile-popup-title">Sort By</div>
            <span class="cusrp-mobile-popup-close" data-close="mobile-sort-popup">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M7 7L17 17M7 17L17 7" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </span>
        </div>
        <div class="cusrp-mobile-popup-content">
            <ul class="cusrp-mobile-sort-options">
                <li>
                    <div class="cusrp-form-check">
                        <input type="radio" name="mobile-sort" id="mobile-sort-name-asc" class="cusrp-sort-radio" value="name-asc" checked>
                        <label for="mobile-sort-name-asc" class="cusrp-filter-label">Name: A to Z</label>
                    </div>
                </li>
                <li>
                    <div class="cusrp-form-check">
                        <input type="radio" name="mobile-sort" id="mobile-sort-name-desc" class="cusrp-sort-radio" value="name-desc" >
                        <label for="mobile-sort-name-desc" class="cusrp-filter-label">Name: Z to A</label>
                    </div>
                </li>
                <li>
                    <div class="cusrp-form-check">
                        <input type="radio" name="mobile-sort" id="mobile-sort-price-low-high" class="cusrp-sort-radio" value="price-low-high">
                        <label for="mobile-sort-price-low-high" class="cusrp-filter-label">Price - Low to High</label>
                    </div>
                </li>
                <li>
                    <div class="cusrp-form-check">
                        <input type="radio" name="mobile-sort" id="mobile-sort-price-high-low" class="cusrp-sort-radio" value="price-high-low">
                        <label for="mobile-sort-price-high-low" class="cusrp-filter-label">Price - High to Low</label>
                    </div>
                </li>
            </ul>
        </div>
    </div>

    <!-- Mobile Filter Popup -->
    <div id="mobile-filter-popup" class="cusrp-mobile-popup">
        <div class="cusrp-mobile-popup-header">
            <div class="cusrp-mobile-popup-title">Filters</div>
            <button id="reset-filters">Reset Filters</button>
            <span class="cusrp-mobile-popup-close" data-close="mobile-filter-popup">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M7 7L17 17M7 17L17 7" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </span>
        </div>
        <div class="cusrp-mobile-popup-content">
            <div class="cusrp-mobile-filter-tabs">
                <div class="cusrp-mobile-filter-sidebar">
                    <ul class="cusrp-mobile-filter-categories">
                        <li class="cusrp-mobile-filter-tab active" data-tab="categories">Categories</li>
                        <li class="cusrp-mobile-filter-tab" data-tab="manufacturers">Manufacturers</li>
                        <li class="cusrp-mobile-filter-tab" data-tab="prescription">Prescription Required</li>
                        <li class="cusrp-mobile-filter-tab" data-tab="price">Price</li>
                    </ul>
                </div>
                <div class="cusrp-mobile-filter-content">
                    <div class="cusrp-mobile-tab-content active" id="categories-content">
                        <div class="cusrp-search-wrapper mb-3">
                            <input type="text" class="cusrp-search-input" id="cusrp-mobile-category-search" placeholder="Search categories..." />
                        </div>
                        <ul id="cusrp-mobile-category-list" class="cusrp-filter-list list-unstyled">
                            <?php foreach ($block->getCategories() as $category): ?>
                                <li class="cusrp-filter-item">
                                    <div class="cusrp-form-check">
                                        <input type="checkbox" class="cusrp-filter-checkbox" data-filter="category" data-value="<?= $category->getId() ?>" id="mobile_cat_<?= $category->getId() ?>">
                                        <label class="cusrp-filter-label" for="mobile_cat_<?= $category->getId() ?>"><?= $category->getName() ?> (<?= $category->getData('product_count') ?>)</label>
                                    </div>
                                </li>
                            <?php endforeach; ?>
                        </ul>
                    </div>
                    <div class="cusrp-mobile-tab-content" id="manufacturers-content">
                        <div class="cusrp-search-wrapper mb-3">
                            <input type="text" class="cusrp-search-input" id="cusrp-mobile-manufacturer-search" placeholder="Search Here..." />
                        </div>
                        <ul id="cusrp-mobile-manufacturer-list" class="cusrp-filter-list list-unstyled">
                            <?php foreach ($block->getManufacturers(10) as $manufacturer): ?>
                                <li class="cusrp-filter-item">
                                    <div class="cusrp-form-check">
                                        <input type="checkbox" class="cusrp-filter-checkbox" data-filter="manufacturer" data-value="<?= $manufacturer['value'] ?>" id="mobile_man_<?= $manufacturer['value'] ?>">
                                        <label class="cusrp-filter-label" for="mobile_man_<?= $manufacturer['value'] ?>"><?= $manufacturer['label'] ?></label>
                                    </div>
                                </li>
                            <?php endforeach; ?>
                        </ul>
                    </div>
                    <div class="cusrp-mobile-tab-content" id="prescription-content">
                        <ul class="cusrp-filter-list list-unstyled">
                            <?php foreach ($block->getPrescriptionOptions() as $option): ?>
                                <li class="cusrp-filter-item">
                                    <div class="cusrp-form-check">
                                        <input type="checkbox" class="cusrp-filter-checkbox" data-filter="prescription_check" data-value="<?= $option['value'] ?>" id="mobile_pres_<?= $option['value'] ?>">
                                        <label class="cusrp-filter-label" for="mobile_pres_<?= $option['value'] ?>"><?= $option['label'] ?></label>
                                    </div>
                                </li>
                            <?php endforeach; ?>
                        </ul>
                    </div>
                    <div class="cusrp-mobile-tab-content" id="price-content">
                        <div id="cusrp-mobile-price-slider" class="cusrp-slider"></div>
                        <span id="cusrp-mobile-price-range" class="cusrp-price-display d-block text-center"></span>
                        <ul class="cusrp-filter-list list-unstyled mt-4">
                            <li class="cusrp-filter-item">
                                <div class="cusrp-form-check">
                                    <input type="checkbox" class="cusrp-range-filter-checkbox" id="price_0_500" data-min="0" data-max="500">
                                    <label class="cusrp-filter-label" for="price_0_500">₹0 - ₹500</label>
                                </div>
                            </li>
                            <li class="cusrp-filter-item">
                                <div class="cusrp-form-check">
                                    <input type="checkbox" class="cusrp-range-filter-checkbox" id="price_500_1000" data-min="500" data-max="1000">
                                    <label class="cusrp-filter-label" for="price_500_1000">₹500 - ₹1000</label>
                                </div>
                            </li>
                            <li class="cusrp-filter-item">
                                <div class="cusrp-form-check">
                                    <input type="checkbox" class="cusrp-range-filter-checkbox" id="price_1000_2000" data-min="1000" data-max="2000">
                                    <label class="cusrp-filter-label" for="price_1000_2000">₹1000 - ₹2000</label>
                                </div>
                            </li>
                            <li class="cusrp-filter-item">
                                <div class="cusrp-form-check">
                                    <input type="checkbox" class="cusrp-range-filter-checkbox" id="price_2000_plus" data-min="2000" data-max="<?= $block->getDefaultPriceMax() ?>">
                                    <label class="cusrp-filter-label" for="price_2000_plus">Above ₹2000</label>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
require(['jquery', 'jquery/ui'], function($) {
    $(document).ready(function() {
        // Don't redefine activeFilters, use the one from filter.phtml
        var activeFilters = window.activeFilters || {
            category: [],
            manufacturer: [],
            prescription_check: [],
            price_min: <?= $block->getDefaultPriceMin() ?>,
            price_max: <?= $block->getDefaultPriceMax() ?>,
            price_ranges: [],
            sort_field: 'price',
            sort_direction: 'desc'
        };
        
        // Make sure global activeFilters is set
        window.activeFilters = activeFilters;
        
        var currentPage = window.currentPage || <?= $block->getData('page') ?: 1 ?>;
        var totalPages = window.totalPages || <?= $block->getData('totalPages') ?: 1 ?>;
        
        // Add this function to sync UI state across views
        function syncFilterUIState() {
            // Update checkboxes on both mobile and desktop
            $('.cusrp-filter-checkbox').each(function() {
                var filter = $(this).data('filter');
                var value = $(this).data('value');
                
                // Check if this value is in activeFilters
                if (window.activeFilters[filter] && 
                    (window.activeFilters[filter].includes(parseInt(value)) || 
                     window.activeFilters[filter].includes(value.toString()))) {
                    $(this).prop('checked', true);
                } else {
                    $(this).prop('checked', false);
                }
            });
    
            // Price slider sync - ensure both desktop and mobile sliders match the global state
            if ($("#cusrp-price-slider").hasClass('ui-slider')) {
                $("#cusrp-price-slider").slider("values", 0, window.activeFilters.price_min);
                $("#cusrp-price-slider").slider("values", 1, window.activeFilters.price_max);
                $('#cusrp-price-range').text('₹' + window.activeFilters.price_min + ' - ₹' + window.activeFilters.price_max);
            }
            
            if ($("#cusrp-mobile-price-slider").hasClass('ui-slider')) {
                $("#cusrp-mobile-price-slider").slider("values", 0, window.activeFilters.price_min);
                $("#cusrp-mobile-price-slider").slider("values", 1, window.activeFilters.price_max);
                $('#cusrp-mobile-price-range').text('₹' + window.activeFilters.price_min + ' - ₹' + window.activeFilters.price_max);
            }
            
            // Update price range checkboxes based on current price_ranges
            $('.cusrp-range-filter-checkbox').each(function() {
                const min = $(this).data('min');
                const max = $(this).data('max');
                const range = min + '-' + max;
                
                if (window.activeFilters.price_ranges.includes(range)) {
                    $(this).prop('checked', true);
                } else {
                    $(this).prop('checked', false);
                }
            });
            
            // Update sort selectors
            let sortValue;
            if (window.activeFilters.sort_field === 'price') {
                sortValue = window.activeFilters.sort_direction === 'desc' ? 'price-high-low' : 'price-low-high';
            } else {
                sortValue = window.activeFilters.sort_field + '-' + window.activeFilters.sort_direction;
            }
            
            $('input[name="mobile-sort"][value="' + sortValue + '"]').prop('checked', true);
        }

        function initMobileSlider() {
            if ($("#cusrp-mobile-price-slider").hasClass('ui-slider')) {
                $("#cusrp-mobile-price-slider").slider('destroy');
            }
            
            $("#cusrp-mobile-price-slider").slider({
                range: true,
                min: <?= $block->getDefaultPriceMin() ?>,
                max: <?= $block->getDefaultPriceMax() ?>,
                values: [window.activeFilters.price_min, window.activeFilters.price_max],
                slide: function(event, ui) {
                    $('#cusrp-mobile-price-range').text('₹' + ui.values[0] + ' - ₹' + ui.values[1]);
                },
                stop: function(event, ui) {
                    window.activeFilters.price_min = ui.values[0];
                    window.activeFilters.price_max = ui.values[1];
                    
                    // Clear price ranges when using the slider directly
                    window.activeFilters.price_ranges = [];
                    $('.cusrp-range-filter-checkbox').prop('checked', false);
                    
                    // Update desktop slider too
                    if ($("#cusrp-price-slider").hasClass('ui-slider')) {
                        $("#cusrp-price-slider").slider("values", 0, ui.values[0]);
                        $("#cusrp-price-slider").slider("values", 1, ui.values[1]);
                        $('#cusrp-price-range').text('₹' + ui.values[0] + ' - ₹' + ui.values[1]);
                    }
                    
                    window.applyFilters();
                }
            });
            
            $('#cusrp-mobile-price-range').text('₹' + window.activeFilters.price_min + ' - ₹' + window.activeFilters.price_max);
        }
        
        // Mobile Filter and Sort Button Handlers
        const mobileSortButton = document.getElementById('mobile-sort-button');
        const mobileFilterButton = document.getElementById('mobile-filter-button');
        const mobileSortPopup = document.getElementById('mobile-sort-popup');
        const mobileFilterPopup = document.getElementById('mobile-filter-popup');
        const closeButtons = document.querySelectorAll('.cusrp-mobile-popup-close');
        
        // Mobile Filter and Sort Button Handlers
        if (mobileSortButton) {
            mobileSortButton.addEventListener('click', function(e) {
                mobileFilterPopup.classList.remove('active');
                
                // Toggle sort popup
                if (mobileSortPopup.classList.contains('active')) {
                    mobileSortPopup.classList.remove('active');
                    document.body.style.overflow = 'auto';
                } else {
                    mobileSortPopup.classList.add('active');
                    
                    const sortValue = `${window.activeFilters.sort_field}-${window.activeFilters.sort_direction}`;
                    let radioValue;
                    
                    switch(sortValue) {
                        case 'price-desc':
                            radioValue = 'price-high-low';
                            break;
                        case 'price-asc':
                            radioValue = 'price-low-high';
                            break;
                        case 'name-asc':
                            radioValue = 'name-asc';
                            break;
                        case 'name-desc':
                            radioValue = 'name-desc';
                            break;
                        default:
                            radioValue = 'price-high-low';
                    }
                    
                    const radio = document.querySelector(`input[name="mobile-sort"][value="${radioValue}"]`);
                    if (radio) {
                        radio.checked = true;
                    }
                }
                e.stopPropagation();
            });
        }

        // Open Filter Popup
        if (mobileFilterButton) {
            mobileFilterButton.addEventListener('click', function(e) {
                mobileSortPopup.classList.remove('active');
                
                if (mobileFilterPopup.classList.contains('active')) {
                    mobileFilterPopup.classList.remove('active');
                    document.body.style.overflow = 'auto';
                } else {
                    mobileFilterPopup.classList.add('active');
                    
                    syncFilterUIState();
                }
                e.stopPropagation();
            });
        }

        // Close popups when clicking outside
        $(document).on('click', function(event) {
            if (!$(event.target).closest('#mobile-sort-popup, #mobile-filter-popup, #mobile-sort-button, #mobile-filter-button').length) {
                $('#mobile-sort-popup, #mobile-filter-popup').removeClass('active');
                document.body.style.overflow = 'auto';
            }
        });

        $(document).on('change', '.cusrp-range-filter-checkbox', function() {
            const checkboxMin = parseInt($(this).data('min'));
            const checkboxMax = parseInt($(this).data('max'));
            const range = checkboxMin + '-' + checkboxMax;
            
            if ($(this).is(':checked')) {
                if (!window.activeFilters.price_ranges.includes(range)) {
                    window.activeFilters.price_ranges.push(range);
                }
            } else {
                window.activeFilters.price_ranges = window.activeFilters.price_ranges.filter(r => r !== range);
            }

            // Sync the checkboxes with same min/max values across desktop and mobile
            $('.cusrp-range-filter-checkbox').each(function() {
                const min = $(this).data('min');
                const max = $(this).data('max');
                const thisRange = min + '-' + max;
                
                if (thisRange === range) {
                    $(this).prop('checked', window.activeFilters.price_ranges.includes(range));
                }
            });

            // Update slider display based on selected ranges
            if (window.activeFilters.price_ranges.length > 0) {
                let minPrice = <?= $block->getDefaultPriceMax() ?>;
                let maxPrice = <?= $block->getDefaultPriceMin() ?>;
                
                // Find min/max for visual display on the slider
                $('.cusrp-range-filter-checkbox:checked').each(function() {
                    const cMin = parseInt($(this).data('min'));
                    const cMax = parseInt($(this).data('max'));
                    
                    if (cMin < minPrice) minPrice = cMin;
                    if (cMax > maxPrice) maxPrice = cMax;
                });
                
                // Update sliders on both views
                if ($("#cusrp-price-slider").hasClass('ui-slider')) {
                    $("#cusrp-price-slider").slider("values", 0, minPrice);
                    $("#cusrp-price-slider").slider("values", 1, maxPrice);
                    $('#cusrp-price-range').text('₹' + minPrice + ' - ₹' + maxPrice);
                }
                
                if ($("#cusrp-mobile-price-slider").hasClass('ui-slider')) {
                    $("#cusrp-mobile-price-slider").slider("values", 0, minPrice);
                    $("#cusrp-mobile-price-slider").slider("values", 1, maxPrice);
                    $('#cusrp-mobile-price-range').text('₹' + minPrice + ' - ₹' + maxPrice);
                }
            } else {
                // Reset slider visuals on both views if no ranges selected
                const defaultMin = <?= $block->getDefaultPriceMin() ?>;
                const defaultMax = <?= $block->getDefaultPriceMax() ?>;
                
                if ($("#cusrp-price-slider").hasClass('ui-slider')) {
                    $("#cusrp-price-slider").slider("values", 0, defaultMin);
                    $("#cusrp-price-slider").slider("values", 1, defaultMax);
                    $('#cusrp-price-range').text('₹' + defaultMin + ' - ₹' + defaultMax);
                }
                
                if ($("#cusrp-mobile-price-slider").hasClass('ui-slider')) {
                    $("#cusrp-mobile-price-slider").slider("values", 0, defaultMin);
                    $("#cusrp-mobile-price-slider").slider("values", 1, defaultMax);
                    $('#cusrp-mobile-price-range').text('₹' + defaultMin + ' - ₹' + defaultMax);
                }
            }
            
            // Apply filters
            window.applyFilters();
        });        
        
        // Close Popups
        closeButtons.forEach(button => {
            button.addEventListener('click', function() {
                const popupId = this.getAttribute('data-close');
                document.getElementById(popupId).classList.remove('active');
                // Re-enable body scrolling
                document.body.style.overflow = 'auto';
            });
        });
        
        // Mobile Filter Tab Navigation
        const filterTabs = document.querySelectorAll('.cusrp-mobile-filter-tab');
        const tabContents = document.querySelectorAll('.cusrp-mobile-tab-content');
        
        filterTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                // Remove active class from all tabs
                filterTabs.forEach(t => t.classList.remove('active'));
                // Add active class to clicked tab
                this.classList.add('active');
                
                // Hide all tab contents
                tabContents.forEach(content => content.classList.remove('active'));
                
                // Show the selected tab content
                const tabId = this.getAttribute('data-tab');
                document.getElementById(`${tabId}-content`).classList.add('active');
        
                // Initialize slider when price tab is selected
                if (tabId === 'price') {
                    setTimeout(initMobileSlider, 100);
                }
            });
        });
        
        // Sort radio buttons handler
        $(document).on('change', '.cusrp-sort-radio', function() {
            const selectedSort = $(this).val();
            
            // Set sort parameters in activeFilters
            switch(selectedSort) {
                case 'name-asc':
                    window.activeFilters.sort_field = 'name';
                    window.activeFilters.sort_direction = 'asc';
                    break;
                case 'name-desc':
                    window.activeFilters.sort_field = 'name';
                    window.activeFilters.sort_direction = 'desc';
                    break;
                case 'price-low-high':
                    window.activeFilters.sort_field = 'price';
                    window.activeFilters.sort_direction = 'asc';
                    break;
                case 'price-high-low':
                    window.activeFilters.sort_field = 'price';
                    window.activeFilters.sort_direction = 'desc';
                    break;
            }
            
            // Update desktop sort select if it exists
            const desktopSortSelect = $('#cusrp-sort-select');
            if (desktopSortSelect.length) {
                desktopSortSelect.val(selectedSort);
            }
            
            // Apply filtering immediately using the global function
            window.applyFilters();
            
            // Close the popup
            $('#mobile-sort-popup').removeClass('active');
            document.body.style.overflow = 'auto';
        });
        
        // Mobile filter checkboxes handling
        $(document).on('change', '.cusrp-filter-checkbox', function() {
            var filter = $(this).data('filter');
            var value = $(this).data('value');
            
            if ($(this).is(':checked')) {
                if (!window.activeFilters[filter].includes(value)) {
                    window.activeFilters[filter].push(value);
                }
            } else {
                window.activeFilters[filter] = window.activeFilters[filter].filter(function(v) {
                    return v !== value;
                });
            }
            
            // Sync the change to desktop view
            $('.cusrp-filter-checkbox[data-filter="' + filter + '"][data-value="' + value + '"]').prop('checked', $(this).is(':checked'));
            
            // No need to call applyFilters here as it will be called when Apply button is clicked
            window.applyFilters();
        });

        // Mobile Reset Filters - reuse the main reset function if available
        $('#mobile-reset-filters, #reset-filters').on('click', function() {
            window.activeFilters = {
                category: [],
                manufacturer: [],
                prescription_check: [],
                price_min: <?= $block->getDefaultPriceMin() ?>,
                price_max: <?= $block->getDefaultPriceMax() ?>,
                sort_field: 'price',
                sort_direction: 'desc'
            };
            
            // Uncheck all checkboxes
            $('.cusrp-filter-checkbox').prop('checked', false);
            
            // Reset sort options
            $('input[name="mobile-sort"][value="price-high-low"]').prop('checked', true);
            $('#cusrp-sort-select').val('price-high-low');
            
            // Reset price slider if it exists
            if ($("#cusrp-mobile-price-slider").hasClass('ui-slider')) {
                $("#cusrp-mobile-price-slider").slider("values", 0, window.activeFilters.price_min);
                $("#cusrp-mobile-price-slider").slider("values", 1, window.activeFilters.price_max);
                $('#cusrp-mobile-price-range').text('₹' + window.activeFilters.price_min + ' - ₹' + window.activeFilters.price_max);
            }
            
            // Reset desktop price slider if it exists
            if ($("#cusrp-price-slider").hasClass('ui-slider')) {
                $("#cusrp-price-slider").slider("values", 0, window.activeFilters.price_min);
                $("#cusrp-price-slider").slider("values", 1, window.activeFilters.price_max);
                $('#cusrp-price-range').text('₹' + window.activeFilters.price_min + ' - ₹' + window.activeFilters.price_max);
            }
            
            // Clear search fields
            $('#cusrp-mobile-category-search, #cusrp-mobile-manufacturer-search, #cusrp-category-search, #cusrp-manufacturer-search').val('');
            
            // Apply filters
            window.applyFilters();
        });

        // Handle window resize events to ensure proper UI state
        $(window).on('resize', function() {
            // If window width is larger than mobile breakpoint and popups are open, close them
            if (window.innerWidth >= 768) {
                $('#mobile-sort-popup, #mobile-filter-popup').removeClass('active');
                document.body.style.overflow = 'auto';
            }
        });
        
        // Mobile category search functionality
        $('#cusrp-mobile-category-search').on('input', function() {
            var search = $(this).val();
            
            $.ajax({
                url: '<?= $block->getUrl('searchresult/filter/categorySearch') ?>',
                data: {search: search},
                success: function(data) {
                    $('#cusrp-mobile-category-list').html(data);
                    
                    // After updating the HTML, restore the checked state
                    $('.cusrp-filter-checkbox[data-filter="category"]').each(function() {
                        var value = $(this).data('value');
                        // Check if this value is in activeFilters
                        if (window.activeFilters.category.includes(parseInt(value)) || 
                            window.activeFilters.category.includes(value.toString())) {
                            $(this).prop('checked', true);
                        }
                    });
                }
            });
        });
        
        // Mobile manufacturer search functionality
        $('#cusrp-mobile-manufacturer-search').on('input', function() {
            var search = $(this).val();
            
            $.ajax({
                url: '<?= $block->getUrl('searchresult/filter/manufacturersearch') ?>',
                data: {search: search},
                success: function(data) {
                    $('#cusrp-mobile-manufacturer-list').html(data);
                    
                    // After updating the HTML, restore the checked state
                    $('.cusrp-filter-checkbox[data-filter="manufacturer"]').each(function() {
                        var value = $(this).data('value');
                        // Check if this value is in activeFilters
                        if (window.activeFilters.manufacturer.includes(parseInt(value)) || 
                            window.activeFilters.manufacturer.includes(value.toString())) {
                            $(this).prop('checked', true);
                        }
                    });
                }
            });
        });
        
        // Initialize by syncing the UI state
        syncFilterUIState();
    });
});
</script>
